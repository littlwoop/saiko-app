name: Build iOS App (Simple - Manual Upload)

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build web app
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_STRAVA_CLIENT_ID: ${{ secrets.VITE_STRAVA_CLIENT_ID }}
          VITE_STRAVA_CLIENT_SECRET: ${{ secrets.VITE_STRAVA_CLIENT_SECRET }}
          VITE_STRAVA_REDIRECT_URI: ${{ secrets.VITE_STRAVA_REDIRECT_URI || 'com.saiko.app://auth/strava/callback' }}

      - name: Setup Capacitor
        run: |
          npm install -g @capacitor/cli
          npx cap sync ios

      - name: Setup CocoaPods
        run: |
          sudo gem install cocoapods
          cd ios/App && pod install && cd ../..

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build iOS Archive (Development)
        run: |
          xcodebuild -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath build/App.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="Apple Development" \
            DEVELOPMENT_TEAM="" \
            CODE_SIGNING_ALLOWED=NO

      - name: Export IPA (Development)
        run: |
          # Create export options for development
          cat > exportOptionsDev.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>development</string>
              <key>signingStyle</key>
              <string>manual</string>
          </dict>
          </plist>
          EOF
          
          xcodebuild -exportArchive \
            -archivePath build/App.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist exportOptionsDev.plist || echo "Export failed - you may need to sign manually in Xcode"

      - name: Create Xcode Project Archive
        run: |
          cd ios/App
          zip -r ../../build/xcode-project.zip . -x "*.xcuserdata/*" "*.xcworkspace/xcuserdata/*" "DerivedData/*"
          cd ../..

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-artifacts
          path: |
            build/ipa/*.ipa
            build/xcode-project.zip
            build/App.xcarchive
          retention-days: 30
          if-no-files-found: warn

      - name: Build Summary
        run: |
          echo "## iOS Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifacts from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Open the Xcode project (xcode-project.zip) on a Mac" >> $GITHUB_STEP_SUMMARY
          echo "3. Configure signing in Xcode with your Apple Developer account" >> $GITHUB_STEP_SUMMARY
          echo "4. Archive and upload to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** For production builds, you'll need to configure code signing. See NO_MAC_SETUP.md for options." >> $GITHUB_STEP_SUMMARY
